# number-generation-app

# number-api
REST-сервис с единственным GET-методом ```/number``` по получению уникального числового идентификатора: 1, 2, 3 и т.д. Идентификатор - целое натуральное число. При каждом вызове данного метода возвращается новый идентификатор. Идентификаторы не повторяются, однако могут идти не по порядку. Используется в связке с number-generator

### Описание работы сервиса
1. Читает из кафки сообщения (топик unique.natural.number), представляющие из себя целые натуральные числа
1. Полученное число кладет в потокобезопасную очередь (буффер)
1. Когда очередь заполняется, перестает вычитывать из кафки и сдвигать оффсет, перепроверяет освободилась ли очередь в цикле с ожиданием
1. Из очереди сообщения берет контроллер при получении запроса на ```/number```
1. Легко масштабируется запуском нескольких инстансов, потребуется только добавить партиций в топик unique.natural.number. Также можно запускать консьюмеров в нескольких потоках

### Описание настроек
1. LISTENERS_COUNT - число консьюмеров параллельно слушающих топик кафки
1. BUFFER_SIZE - размер очереди, в которую складываются сообщения из кафки


# number-generator
Сервис генерирует неповторяющиеся целые натуральные числа и записывает их в кафку. Необходим для number-api

### Описание работы сервиса
1. Читает из кафки сообщения (топик generation.ranges), представляющие из себя диапазоны в виде json: ```{"start":long,"end":long}```
1. Генерим числа в рамках считанного диапазона и отправляем их в топик unique.natural.number
1. Легко масштабируется запуском нескольких инстансов, потребуется только добавить партиций в топик generation.ranges. Также можно запускать консьюмеров в нескольких потоках

### Описание настроек
1. LISTENERS_COUNT - число консьюмеров параллельно слушающих топик кафки


# range-generator
Сервис генерирует неповторяющиеся диапазоны целых чисел и записывает их в кафку. Необходим для number-generator

### Описание работы сервиса
1. Читает из кафки сообщения (топик generation.ranges), представляющие из себя диапазоны в виде json: ```{"start":long,"end":long}```
1. Из полученного диапазона вычисляет следующий и записывает его в кафку в тот же топик
1. Имеется служебный ендпойнт ```/init-ranges``` для создания первой записи в топике и запуска дальнейшей работы сервиса.
    + startNumber - стартовое число
    + range - размер диапазонов, которые будет генерировать сервис. Лучше всего делать не больше чем `(startNumber-LAST_NUMBER)/<кол-во инстансов number-generator>` для равномерного распределения между number-generator-ами

### Описание настроек
1. LAST_NUMBER - максимальное число, которое будет сгенерировано
1. ENABLE_INIT_CONTROLLER - включение служебного ендпойнта ```/init-ranges```

# Сборка и запуск
+ Собрать все модули можно командой в корне проекта ```gradle build``` или ```gradle build -x test``` (без тестов)
+ Собрать jar-ники всех модулей в докер образы можно командой ```docker-compose build```
+ Запустить собранные образы в контейнерах командой:
    ```
    docker-compose up --scale number-api=3 --scale number-generator=3 -d
    ```
    + Где ```--scale number-api=3``` означает что надо запустить 3 инстанса number-api. 
    + Порты мультиинстансных приложений пробрасываются на случайные порты хост системы, узнать их можно командной: ```docker ps```
+ Если необходимо пересобрать образы, то добавить к предыдущей команде ```--build```
+ Просмотр информации об определенном контейнере по имени:
    ```
    docker ps -f "name=number-generation-app_number-generator_2"
    ```
+ Запустить только выбранные сервисы через docker-compose можно так:
    ```
    docker-compose up -d zookeeper kafka range-generator
    docker-compose up -d number-generator
    docker-compose up --scale number-generator=3 -d number-generator
    ```